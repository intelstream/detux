# Detux: The Multiplatform Linux Sandbox
Since the original Detux.org seems to have disappeared, this repo is to get a new iteration of it online for free Linux malware analysis, hosted under the IntelStream group.

## Table of Contents
- Introduction
  - What's in this release?
  - What's in the report?
- Requirements
  - System Requirements
  - Python Requirements
- Architecture
  - Network Arch
  - VM Setup:
    - Downloading Linux VM Images
  - Setting sudoers for qemu execution
  - Network setup
  - Setting up your VMs
  - Comands for Booting the VMs \(Replace \[MACADDR\] with the MAC you desire\):
    - Setting up your snapshot
    - Setting capture permisisons
    - Detux Config
- Running Detux
  - Usage
- Credits
  - Original Detux Contributors
  - Thanks

## Introduction
Detux is a sandbox developed to do traffic analysis of the Linux malwares and capture the IOCs by doing so. QEMU hypervisor is used to emulate Debian GNU/Linux for various CPU architectures.

The following CPUs are currently supported:
* x86
* x86-64
* ARM
* MIPS
* MIPSEL

Use the Live version *soon* at: https://detux.intelstream.io

### What's in this release?
This updated release of Detux contains the code for executing a Linux binary or script with a specified CPU architecture, the back-end database connectivity required for storage and search, and the web front-end UI that allows users to submit samples or search previously analyzed samples.

x86 is set to the default CPU version but this can be tuned in the config file. When a file is submitted, Detux picks the proper CPU architecture in an automated fashion.

Currently, this repo returns the analysis report in as a JSON file, which can be easily customized to be inserted in to NoSQL databases

An example script has been provided which demonstrates the usage of the sandbox library.

### What's in the report?
* Static Analysis
    * Basic strings extracted from binary
    * ELF information generated by readelf commands
    * the report.py can be modified to add more 3rd party commands to analyse the binary and add the result to `Dict()`.
* Dynamic Analysis
    * Captured pcaps are parsed with DPKT to extract the IOC's and readable information

## Requirements
Make sure you setup the requirements below before trying to use Detux. Ideally, the Python libraries will be installed within a virtual environment. The exact system package names may change depending on your host distribution.

### System Requirements
- python 3.6
- qemu
- pcaputils
- sudo
- libcap2-bin
- bridge-utils

### Python Requirements
- pexpect
- paramiko
- python-magic


## Architecture
- Host (Can be a VM or baremetal)
    - QEMU
    - dumpcap
    - DETUX Scripts

### Network Arch
- NIC1 : This interface is for accessing the Host
- NIC2 : Interface bridged with the the QEMU Sandbox VMs. One can redirect the traffic from the interface to WHONIX or REMNUX or a custom Gateway to filter/allow internet access for the Sandboxed VMs.


### VM Setup
#### Downloading Linux VM Images
Special thanks to aurel who has uploaded pre built QEMU Debian VM images for all possible CPU architectures.
The VM images are located at : https://people.debian.org/~aurel32/qemu/, the same link contains the command examples for invoking the vm images.

You can use the following script to automatically download the VM images to the "qemu" folder of Detux.

```
#x86
echo "Downloading i386 ..."
wget https://people.debian.org/~aurel32/qemu/i386/debian_wheezy_i386_standard.qcow2 -P qemu/x86/1/


#x86-64
echo "Downloading amd64 ..."
wget https://people.debian.org/~aurel32/qemu/amd64/debian_wheezy_amd64_standard.qcow2 -P qemu/x86-64/1/

#arm
echo "Downloading ARM ..."
wget https://people.debian.org/~aurel32/qemu/armel/debian_wheezy_armel_standard.qcow2 -P qemu/arm/1/
wget https://people.debian.org/~aurel32/qemu/armel/initrd.img-3.2.0-4-versatile -P qemu/arm/1/
wget https://people.debian.org/~aurel32/qemu/armel/vmlinuz-3.2.0-4-versatile -P qemu/arm/1/

#mips
echo "Downloading MIPS ..."
wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-3.2.0-4-4kc-malta -P qemu/mips/1/
wget https://people.debian.org/~aurel32/qemu/mips/debian_wheezy_mips_standard.qcow2 -P qemu/mips/1/

#mipsel
echo "Downloading MIPSEL ..."
wget https://people.debian.org/~aurel32/qemu/mipsel/vmlinux-3.2.0-4-4kc-malta -P qemu/mipsel/1/
wget https://people.debian.org/~aurel32/qemu/mipsel/debian_wheezy_mipsel_standard.qcow2 -P qemu/mipsel/1/
```

#### Setting sudoers for qemu execution
Detux uses SSH to communicate with the VMs. This is currently required for the VMs to have networking capability. Considering that the listed binaries are in the same path, if you are a non-root user add the following lines to `/etc/sudoers`:

```
Cmnd_Alias  QEMU_CMD    =   /usr/bin/qemu-*, /sbin/ip, /sbin/ifconfig, /sbin/brctl
<your detux username here> ALL = (ALL) NOPASSWD: QEMU_CMD
```

Change the paths to the binaries if they differ for you.

#### Network setup
Add the following config to /etc/qemu-ifup and backup the original if you already have one

```
#! /bin/sh
# Script to bring a network (tap) device for qemu up.
# The idea is to add the tap device to the same bridge
# as we have default routing to.

# in order to be able to find brctl
PATH=$PATH:/sbin:/usr/sbin
ip=$(which ip)
ifconfig=$(which ifconfig)

echo "Starting"  $1
if [ -n "$ip" ]; then
   ip link set "$1" up
else
   brctl=$(which brctl)
   if [ ! "$ip" -o ! "$brctl" ]; then
     echo "W: $0: not doing any bridge processing: neither ip nor brctl utility not found" >&2
     exit 0
   fi
   ifconfig "$1" 0.0.0.0 up
fi

switch=$(ip route ls | \
    awk '/^default / {
          for(i=0;i<NF;i++) { if ($i == "dev") { print $(i+1); next; } }
         }'
        )
    if [ -d /sys/class/net/br0/bridge/. ]; then
        if [ -n "$ip" ]; then
          ip link set "$1" master br0
        else
          brctl addif br0 "$1"
        fi
        exit    # exit with status of the previous command
    fi

echo "W: $0: no bridge for guest interface found" >&2
```

Considering that eth0 is the interface you want your VMs to be bridged with, you may remove the configs for eth0 and use the following configs in /etc/network/interfaces:
```
auto br0
iface br0 inet dhcp
  bridge_ports eth0
  bridge_maxwait 0
```
You can also specify a static address you used for eth0.

## Setting up your VMs
* Traverse to the folder in which your VM images are located for each QEMU Images.
    * For example, ARM would be: `<your detux folder>/qemu/arm/1/`
* For each image, follow the VM boot instructions given at "https://people.debian.org/~aurel32/", to start the VM. If you are a non-root user, you'll need to use `sudo` for the commands.

### Comands for Booting the VMs
Replace [MACADDR] in the script below with the MAC you want to use.

```
#x86
sudo qemu-system-i386 -hda qemu/x86/1/debian_wheezy_i386_standard.qcow2 -vnc 127.0.0.1:5901 -net nic,macaddr=[MACADDR] -net tap -monitor stdio


#x86-64
sudo qemu-system-x86_64 -hda qemu/x86-64/1/debian_wheezy_amd64_standard.qcow2 -vnc 127.0.0.1:5901 -net nic,macaddr=[MACADDR] -net tap -monitor stdio

#arm
sudo qemu-system-arm -M versatilepb -kernel qemu/arm/1/vmlinuz-3.2.0-4-versatile -initrd qemu/arm/1/initrd.img-3.2.0-4-versatile -hda qemu/arm/1/debian_wheezy_armel_standard.qcow2 -append "root=/dev/sda1" -vnc 127.0.0.1:5901 -net nic,macaddr=[MACADDR] -net tap -monitor stdio

#mips
sudo qemu-system-mips -M malta -kernel qemu/mips/1/vmlinux-3.2.0-4-4kc-malta -hda qemu/mips/1/debian_wheezy_mips_standard.qcow2 -append "root=/dev/sda1 console=tty0" -vnc 127.0.0.1:5901 -net nic,macaddr=[MACADDR] -net tap -monitor stdio

#mipsel
sudo qemu-system-mipsel -M malta -kernel qemu/mipsel/1/vmlinux-3.2.0-4-4kc-malta -hda qemu/mipsel/1/debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -vnc 127.0.0.1:5901 -net nic,macaddr=[MACADDR] -net tap -monitor stdio
```

Detux requires a preconfigured VM snapshot with IP addresses and ssh setup.

### Setting up your snapshot
* Choose an unconfigured VM image and start it using the above listed command in a Terminal.
* Connect VM monitor. Connect a VNC client to 127.0.0.1:5901 and wait for the VM to boot completely.
* Login with the default root credentials (root/root).
* Configure the VM's network interface such that it reachable/ accessible to the host.
* Setup SSH server on the VM and anyother configuration if required for you.
* Once configured, boot to a running state that accepts network connection.
* Switch back to terminal with qemu console on, which should look like: `(qemu)`
* Save the VM state typing the following qemu commands in the qemu console: `(qemu) savevm init`
* Quit the QEMU console: `(qemu) q`
* **Repeat above steps for all the VMs**


### Setting capture permisisons
In order for a non-root user to be able to capture packets, Dumpcap needs capture privileges.  (https://wiki.wireshark.org/CaptureSetup/CapturePrivileges).

The following command may enable the same for you:
```
sudo groupadd -g wireshark
sudo usermod -a -G wireshark <your user name>
sudo chmod 750 /usr/bin/dumpcap
sudo setcap cap_net_raw,cap_net_admin=eip /usr/bin/dumpcap
```

Keep in mind that you might have to logout and login again or reboot the host to apply the permissions.
If you are unable to capture packets or you get errors related to dumpcap, you need to check if permissions for your users are set correctly and the dumpcap path is right.

### Detux Config
The detux.cfg files in the main directory needs to be configured. Each VM section has to be configured with correct Network Params and SSH credentials. You can choose root/non-root user depending on your need.

## Running Detux
The Detux library located in "core" directory can be used to suit your need of analysis.
The repo contains "detux.py" which analyses the given binary and saves pcap in pcap folder and writes JSON output to a specified filepath.

### Usage
```
usage: detux.py [-h] --sample SAMPLE [--cpu {x86,x86-64,arm,mips,mipsel}]
                [--int {python,perl,sh,bash}] --report REPORT

optional arguments:
  -h, --help            show this help message and exit
  --sample SAMPLE       Sample path (default: None)
  --cpu {x86,x86-64,arm,mips,mipsel}
                        CPU type (default: auto)
  --int {python,perl,sh,bash}
                        Architecture type (default: None)
  --report REPORT       JSON report output path (default: None)
```

**Example:**
`python detux.py --sample test_script/example_binary1 --report reports/example_report1.json`

## Credits
### Original Detux Contributors
* Vikas Iyengar - The brain ( [dudeintheshell](https://github.com/dudeintheshell) , email: iyengar.vikas@gmail.com )
* Muslim Koser - Technichal thought works (muslimk@gmail.com)
* Rahul Binjve - Help in pcap parsing ([@c0dist](https://github.com/c0dist), [twitter](https://twitter.com/c0dist))
* Amey Gat - Help in pcap parsing ([ameygat](https://github.com/ameygat), ameygat@gmail.com )

### Thanks
Thanks to Aurélien Jarno (@aurel32) (https://www.aurel32.net/) for the pre-built VM images.
